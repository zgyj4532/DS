附件编号：[附件一]
文件名称：《[软件名称] V[版本号] 功能清单》
合同关联：本清单为《[合同全称]》（合同编号：[编号]）不可分割部分，与主合同具有同等法律效力。

<!-- 表格渲染样式：固定布局、缩小字体、列宽分配、换行 -->
<style>
table { table-layout: fixed; width: 100%; font-size: 11px; line-height: 1.2; border-collapse: collapse; }
table th, table td { word-wrap: break-word; overflow-wrap: break-word; white-space: normal; padding: 6px 8px; vertical-align: top; }
/* 列宽按表格中列数与常用内容分配，适用于 6 列的子功能细化表 */
table tr th:nth-child(1), table tr td:nth-child(1) { width: 12%; }
table tr th:nth-child(2), table tr td:nth-child(2) { width: 12%; }
table tr th:nth-child(3), table tr td:nth-child(3) { width: 30%; }
table tr th:nth-child(4), table tr td:nth-child(4) { width: 28%; }
table tr th:nth-child(5), table tr td:nth-child(5) { width: 6%; }
table tr th:nth-child(6), table tr td:nth-child(6) { width: 12%; }
/* 兼容单列宽度不同的表格，尽量避免文字溢出 */
@media print { table { font-size: 10px; } }
</style>

一、基础信息

- **软件名称**:电商小程序
- **版本号**:v0.2.61
- **交付环境**: :
- **清单版本**: :
- **生效日期**: :

二、功能模块清单

- **子功能细化表**:

    | 功能模块 | 子功能       | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|-----------|---|---|---:|---|
    | 用户管理 | 账号注册      | 支持手机号+验证码注册，必填字段：手机号、密码、姓名（推荐码可选） | 手机号格式校验；验证码有效期5分钟；手机号唯一；创建成功返回 user_id；接口响应≤500ms | 高 | 需对接短信API |
    | 用户管理 | 登录认证      | 账号密码登录、支持微信小程序一键登录，返回 JWT token（有效期1天） | 密码校验通过；失败计数锁定策略生效（示例：连续5次失败锁定10分钟）；登录成功返回 token 与用户信息；接口响应≤500ms | 高 | 支持 refresh token |
    | 用户管理 | 用户信息维护    | 支持修改昵称、手机号、头像、密码、个人资料 | 修改后返回最新用户信息；字段校验生效；密码修改需原密码或验证码验证；接口响应≤500ms | 中 | 头像通过专门接口上传 |
    | 用户管理 | 地址管理      | 收货地址增/删/改/查、设为默认、退货地址管理 | 默认地址唯一；地址录入带省市区校验；接口返回地址列表且分页；设置默认时原默认取消 | 中 | 地址与用户系统统一管理（见 services/address_service.py） |
    | 用户管理 | 头像上传      | 支持图片上传、裁剪、压缩，返回可访问 URL | 支持 jpeg/png；文件大小≤2MB；图片处理成功并返回 URL；访问权限正确 | 低 | 使用 Pillow 处理，存储到 `pic_data/` |
    | 用户管理 | 密码找回      | 短信验证码找回并重设密码，含强度校验 | 验证码有效且只能使用一次；新密码符合强度规则；操作有记录和时戳 | 高 | 需短信 API 集成 |
    | 用户管理 | 绑定推荐人     | 用户可通过推荐码或推荐人手机号绑定推荐人关系 | 推荐关系唯一且不可重复绑定；绑定后在用户信息中可见上级信息 | 低 | 绑定需防止循环引用 |
    | 用户管理 | 查询直推/团队   | 支持查询直推用户列表与团队列表（可递归至 N 层，默认6层） | 支持分页与筛选；返回层级与关系链；响应合理时间（示例≤1s） | 低 | 支持导出报表 |
    | 用户管理 | 用户列表与导出   | 管理端分页筛选用户并支持导出json | 筛选条件正确、导出数据完整性校验通过；导出文件格式正确，导出时间≤30s（小于10k条） | 中 | 导出需相应权限 |
    | 用户管理 | 冻结/注销     | 管理端冻结用户/用户自助注销（逻辑删除） | 冻结后不可登录、不可下单；注销为逻辑删除并保留必要数据（按保留期策略） | 高 | 注销需二次确认与备份 |
    | 用户管理 | 会员升级/设置等级 | 支持用户升级会员、后台调整等级 | 升级后权限/价格生效；历史变更记录保存；升级接口幂等 | 中 | 可能涉及支付或后台审批 |
    | 用户管理 | 多类型积分管理   | 支持会员积分、商家积分、可提现余额、推荐/团队/周补贴/联创专用点数的增减与查询                | Decimal(10,4)精度保证；余额实时更新；流水记录完整；四种专用点查询准确；接口响应≤500ms |   高 | 积分增减需记录原因；支持正负值操作；points\_log表不存在时自动创建                  |
    | 用户管理 | 联创自动晋升    | 基于直推六星数、有效线数、团队总六星数自动计算并晋升联创等级（1-3星）                    | 算法严格符合ABCD条件；过滤已注销用户；晋升原子操作；状态查询≤1s；晋升记录可审计          |   高 | 递归查询深度6层；自动创建user\_unilevel表；后端计算避免前端篡改；需每日任务刷新计数       |
    | 用户管理 | 商户身份授予与查询 | 后台授予用户商户身份，支持设置专属退货地址                                   | Admin key验证；动态添加is\_merchant字段；重复授予返回提示；状态查询准确       |   中 | 需admin2025/gm2025口令；授予后可设置addr\_type='return'地址         |
    | 用户管理 | 平台退货地址配置  | 管理员设置平台级退货地址（user\_id=0），所有用户可公开查询                      | 公开接口无需认证；admin key修改；唯一默认地址；外键约束临时禁用                 |   中 | 特殊user\_id=0标识；查询接口无权限限制；修改时需SET FOREIGN\_KEY\_CHECKS=0 |
    | 用户管理 | 优惠券查询     | 查询用户优惠券列表，支持按状态筛选（未使用/已使用/已过期/全部）                       | 分页准确；状态筛选有效；过期状态自动计算；返回完整券信息；接口响应≤500ms              |   中 | 需coupons表结构；user\_id为必填查询参数；支持all/unused/used/expired筛选 |
    | 用户管理 | 后台手机号管理   | 管理员通过用户ID查询手机号或直接修改（无需验证码）                              | Admin key验证；新旧手机号格式校验；重复性检查；修改原子性；接口响应≤500ms         |   低 | 需gm2025口令；跳过短信验证用于紧急场景；操作需记录审计                          |
    | 用户管理 | 数据库动态兼容   | 自动检测并创建缺失的业务字段（status/member\_level/is\_merchant/积分字段等） | SHOW COLUMNS检测准确；ALTER TABLE成功；无数据丢失；启动时自动执行；兼容老库    |   高 | 核心兼容性设计；所有业务接口前置检测；支持平滑升级；需数据库DDL权限                     |

    

  - **验收表**:

    - 账号注册 / 登录（`/user/auth`）
      - 接口示例: POST `/api/user/auth` {"mobile":"13800000000","password":"pwd","name":"张三"}
      - 期望响应: 200 -> 新用户返回 {uid, token, level, is_new=true}；已存在用户返回 {uid, token, level, is_new=false}
      - 验收步骤: 验证手机号/密码正确登录；错误密码返回400；新用户能在 users 表创建记录；token 可用作后续鉴权；接口响应≤500ms
      - 异常用例: 密码错误、手机号不存在（注册用例）、并发注册唯一性保证

    - 冻结/注销/恢复（`/user/set-status`, `/user/freeze`, `/user/unfreeze`, `/user/self-delete`）
      - 接口示例: POST `/api/user/set-status`、PUT `/api/user/freeze`（需 admin_key）
      - 期望响应: 200 -> 操作成功标识或提示已无变化
      - 验收步骤: 调用冻结后账号无法登录并拒绝下单；解冻后恢复正常；自助注销需提供密码且为幂等操作；变更写入 `audit_log` 表
      - 异常用例: 非法 admin_key 返回403；对已注销用户的冻结返回合理提示；并验证 DDL 自动添加 status 字段场景

    - 修改资料（`/user/update-profile`）
      - 接口示例: POST `/api/user/update-profile` {"mobile":"...","name":"新名","old_password":"...","new_password":"..."}
      - 验收步骤: 修改昵称/头像/密码生效；密码修改需校验旧密码；无更新字段返回提示；字段嗅探（兼容老库）正确
      - 异常用例: 旧密码错误返回400；字段不存在时忽略且不报错

    - 密码找回与后台重置（`/user/reset-password`, `/admin/user/reset-pwd`）
      - 接口示例: POST `/api/user/reset-password` {mobile,sms_code,new_password}；PUT `/api/admin/user/reset-pwd`（需 admin_key）
      - 验收步骤: 正确验证码能重置密码；后台重置通过 admin_key 无需验证码；密码哈希写入数据库
      - 异常用例: 错误验证码返回400；未注册手机号返回404；非法 admin_key 返回403

    - 会员升级/调星（`/user/upgrade`, `/user/set-level`）
      - 接口示例: POST `/api/user/upgrade?mobile=...`；POST `/api/user/set-level` {mobile,new_level,reason}
      - 验收步骤: 升级/调星后 `member_level` 字段正确更新；记录审计日志；超限（>6）返回400；幂等性校验

    - 用户详情与列表（`/user/info`, `/user/list`）
      - 接口示例: GET `/api/user/info?mobile=...`；GET `/api/user/list?page=1&size=20`
      - 验收步骤: 详情返回用户基本信息、上级信息、直推数与团队数；分页接口返回 rows/total，筛选条件生效；被注销用户返回404
      - 异常用例: 非法范围参数返回400

    - 推荐/团队相关（`/user/bind-referrer`, `/user/refer-direct`, `/user/refer-team`）
      - 接口示例: POST `/api/user/bind-referrer` {mobile, referrer_code/referrer_mobile}
      - 验收步骤: 绑定后 `user_referrals` 和 `users.referral_id` 写入；直推/团队查询返回正确的分页与层级；防止循环绑定
      - 异常用例: 推荐码/手机号不存在返回404；重复绑定保持幂等

    - 地址管理（`/address`, `/address/list`, `/address/{id}`, `/address/default`, `/address/return`, `/address/platform-return`）
      - 接口示例: POST `/api/address`、GET `/api/address/list?mobile=...`、GET `/api/address/platform-return`
      - 验收步骤: 地址增删改查字段校验（省市区、所属用户校验）；默认地址唯一；商家退货地址仅商家可写；平台退货地址公开查询
      - 异常用例: 非归属用户操作返回403；地址表字段兼容性（嗅探）验证

    - 头像上传（`/user/{user_id}/avatar`）
      - 接口示例: POST `/api/user/{user_id}/avatar` multipart 文件
      - 验收步骤: 支持 1-3 张、单张≤2MB、JPG/PNG/WEBP；留空则清空头像；返回 URL 列表；与 `UserService.upload_avatar` 行为一致
      - 异常用例: 非法文件类型或超大文件返回400；权限校验（仅本人或管理员）

    - 积分操作与查询（`/points`, `/points/balance`, `/points/log`, `/points/summary`）
      - 接口示例: POST `/api/points` {mobile,type,amount,reason}；GET `/api/points/balance?mobile=...`
      - 验收步骤: 积分增减写入 `points_log`；余额查询返回 member/merchant/withdrawable 字段；流水分页/总数正确；Decimal 精度为4位
      - 异常用例: 非法用户返回404；非法金额或类型返回400

    - 商户身份管理（`/user/grant-merchant`, `/user/is-merchant`）
      - 接口示例: POST `/api/user/grant-merchant?mobile=...&admin_key=gm2025`
      - 验收步骤: 正确 admin_key 能赋予 is_merchant=1；重复赋予返回提示；`/user/is-merchant` 返回布尔
      - 异常用例: 非法 admin_key 返回403；手机号不存在返回404

    - 微信小程序登录（`/user/wechat-login`）
      - 接口示例: POST `/api/user/wechat-login` JSON {code,nickName}
      - 验收步骤: 能正确调用 `WechatService.get_openid_by_code`（沙箱或模拟）；未注册时自动注册；返回 token
      - 异常用例: 无效 code 返回 400/500；异常时返回 500 并记录日志

    - 管理端手机号/后台修改（`/user/mobile` GET/PUT）
      - 接口示例: GET `/api/user/mobile?user_id=...&key=gm2025`；PUT `/api/user/mobile?user_id=...&old_mobile=...&new_mobile=...&key=gm2025`
      - 验收步骤: admin_key 校验；修改时旧号校验、新号唯一性校验；更新后能用新号登录
      - 异常用例: 非法 admin_key 返回403；旧号不匹配或新号已被占用返回相应错误

    - 联创/积分汇总与管理（`/user/unilevel`, `/user/unilevel/status`, `/user/unilevel/promote`, `/all-points` 等）
      - 接口示例: GET `/api/user/unilevel?mobile=...`；POST `/api/unilevel/promote?user_id=...`
      - 验收步骤: 返回联创等级/状态准确；自动晋升逻辑与 `UserService.promote_unilevel_auto` 保持一致并记录变更；权限限制正确
      - 异常用例: 已为最高等级返回400；非法用户返回404

    - 验收文档要求（统一模板）:
      1. 接口示例（HTTP 方法、URL、请求体/Query、响应示例）
      2. 验收步骤（正常用例、边界用例、并发/幂等性用例、错误用例）
      3. 数据库验证点（需检查的表/字段、DDL 自动添加场景）
      4. 性能目标（响应时间、分页导出时间等）
      5. 第三方依赖与准备（短信 API、微信小程序 AppID/密钥、admin_key 测试值）


- **模块**: 订单系统
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 订单系统 | 购物车管理 | 支持加入、移除、更新数量、批量勾选与清空；购物车与库存、商品上下架状态联动 | 加入/移除/更新接口响应≤500ms；选中状态正确影响结算；并发扣减前校验选中项库存；数据一致性经抽样检查通过 | 高 | 购物车接口应支持批量操作 |
    | 订单系统 | 订单创建 | 支持购物车结算与立即购买；地址/自提选项；生成唯一 `order_number`；库存校验与事务性写入订单与明细 | 创建成功返回 `order_number`；下单过程原子性（库存扣减、订单明细、分账在同一事务或补偿机制）；重复提交幂等处理；接口响应≤1s | 高 | 需考虑乐观/悲观锁策略 |
    | 订单系统 | 库存校验与扣减 | 下单时校验 SKU 库存并扣减，支持库存回滚（退款/取消） | 并发场景库存不出现负数；扣减与回滚日志完整；库存变更记录可审计 | 高 | 与 `product_skus` 表字段关联 |
    | 订单系统 | 支付对接 | 支持微信，处理支付回调并触发财务结算与订单状态变更 | 支付回调幂等；支付成功后结算逻辑（分账/积分/优惠）正确；回调异常重试策略；支付成功率指标（合同可填） | 高 | 需商户密钥与沙箱测试账号 |
    | 订单系统 | 积分与优惠券抵扣 | 在支付前校验并应用积分与优惠券，计算实际应付金额 | 抵扣计算正确、不能超额抵扣；抵扣并发安全；使用后状态变更不可重复使用 | 中 | 抵扣规则外放配置 |
    | 订单系统 | 订单状态流转 | 支持状态：`pending_pay`/`pending_ship`/`pending_recv`/`completed`/`refund`/`refunded` 等，提供管理员与用户端查询与变更接口 | 状态变更符合业务规则（例如支付后变为待发货）；状态更改幂等；通知/消息触发正确 | 高 | 发货后自动收货策略需明示 |
    | 订单系统 | 商家发货与快递跟踪 | 写入快递单号并变更状态，支持商家查询订单与批量发货 | 发货接口返回成功率高；跟踪号保存并可回溯；查询时包含订单商品明细 | 中 | 支持导出发货单 |
    | 订单系统 | 退款与退货管理 | 支持用户申请退款/退货、商家/平台审核、退货地址填写、退款回退资金处理 | 退款申请有唯一记录；审核后资金回滚（调用 reverse_split_on_refund）并验证账目平衡；退货地址必须在同意退货时提供 | 高 | 需要与财务模块对账 |
    | 订单系统 | 自动取消与自动收货 | 支持过期未支付自动取消；已发货过期自动确认收货（可配置天数） | 守护任务稳定运行；自动操作记录；取消/自动收货触发相应的库存或结算逻辑 | 中 | 存在守护线程/定时任务（见 order.py） |
    | 订单系统 | 订单查询与详情 | 支持按用户、订单号、状态、多条件查询；详情返回用户、地址、商品明细、支付与物流信息 | 列表支持分页与筛选；详情接口返回完整结构、字段无歧义；查询响应≤1s（小数据集） | 高 | 包含第一条商品摘要与规格 |
    | 订单系统 | 商家后台订单管理 | 商家可按状态查询、发货、审核退款、查看结算明细 | 权限隔离；商家操作仅作用于其订单范围；结算明细与流水一致 | 中 | 商家与平台权限需区分 |
    | 订单系统 | 报表与导出 | 支持按日/周/月导出销售报表、订单明细、退款统计 | 导出文件格式正确、数据完整；导出性能满足约定（示例：≤30s 小于10k条） | 低 | 可异步生成并通知下载 |

    - **验收表**:

      - 创建订单 — POST `/api/order/create`
        - 请求示例 (JSON):
          {
            "user_id": 123,
            "delivery_way": "platform",           # platform|pickup
            "address_id": 45,
            "custom_address": null,
            "specifications": "",
            "buy_now": false,
            "buy_now_items": null
          }
        - 期望响应: 200 -> {"order_number": "20251230123456123456"}
        - 验收步骤:
          1. 正常下单（购物车/立即购买）返回 `order_number`，orders 与 order_items 写入且一致。
          2. 下单时若 `product_skus` 存在 `stock` 字段，检查 stock 减少相应数量；并发场景抽样检查不出现负库存。
          3. 确认 `split_order_funds(order_number, ...)` 被触发的后置影响（可通过 account_flow 或 fund_pools 表项校验 biz_no=order_number 的预留记录）。
          4. 购物车结算场景清空相应购物车记录（若 buy_now=false）。
          5. 重放相同请求（幂等/重试）不导致重复创建或多扣库存。
        - SQL 验证点:
          - SELECT * FROM orders WHERE order_number='20251230123456123456';
          - SELECT * FROM order_items WHERE order_id=(SELECT id FROM orders WHERE order_number='20251230123456123456');
          - SELECT stock FROM product_skus WHERE id=<<sku_id>>; -- 确认库存已扣减
        - 异常用例:
          - 购物车为空或地址缺失返回 422。
          - 库存不足返回明确错误并不创建订单。

      - 支付接口 — POST `/api/order/pay`
        - 请求示例:
          {"order_number":"20251230123456123456","pay_way":"wechat","coupon_id":null,"points_to_use":"0"}
        - 期望响应: 200 -> {"ok": true}
        - 验收步骤:
          1. 验证非法 `pay_way` 返回 422。
          2. 对不存在订单返回 404；对非 `pending_pay` 状态返回 400。
          3. 使用积分抵扣时：校验用户 `member_points` 足够，调用后 points_log/points 变动正确。
          4. 使用优惠券时：核实 coupon 状态并标记为已用，优惠金额计入结算。
          5. 调用 `FinanceService.settle_order(...)` 完成结算后，创建/更新 account_flow（biz_no=order_number）及相关账目；订单状态变为 `pending_ship` 或 `pending_recv`。
        - SQL 验证点:
          - SELECT status FROM orders WHERE order_number='20251230123456123456'; -- pending_ship/pending_recv
          - SELECT * FROM account_flow WHERE biz_no='20251230123456123456';
          - SELECT * FROM points_log WHERE order_no='20251230123456123456';
          - SELECT used FROM coupons WHERE id=<<coupon_id>> (若使用了优惠券)
        - 异常用例:
          - 非法支付方式 422；订单不存在 404；状态异常 400；积分不足或优惠券不可用 400

      - 用户订单列表 — GET `/api/order/{user_id}`
        - 请求示例: GET `/api/order/123?status=pending_pay`
        - 期望响应: 列表，每条包含订单主信息与首条商品明细、规格
        - 验收步骤: 验证分页/筛选参数生效；按 status 筛选仅返回匹配状态的订单；数据与 orders 表一致
        - SQL 验证: SELECT COUNT(*) FROM orders WHERE user_id=123 AND status='pending_pay'; SELECT * FROM orders WHERE user_id=123 LIMIT ...

      - 订单详情 — GET `/api/order/detail/{order_number}`
        - 期望响应: {"order_info":..., "user":..., "items":..., "address":..., "specifications":...}
        - 验收步骤: 验证返回结构包含 `order_info`（不混淆用户字段）、`user`（id/name/mobile）、`items`（每条包含 product_id/sku/price/quantity）和 `address`；`specifications` 从 orders.refund_reason 字段透传；数据与 DB 一致
        - SQL 验证: SELECT * FROM orders WHERE order_number='...'; SELECT * FROM order_items WHERE order_id=...; SELECT id,name,mobile FROM users WHERE id=...;

      - 更新状态 — POST `/api/order/status`
        - 请求示例: {"order_number":"...","new_status":"cancelled","reason":"超时未支付"}
        - 期望响应: {"ok": true}
        - 验收步骤:
          1. 状态变更应为幂等（相同目标状态二次调用不报错）。
          2. 根据业务流触发副作用：如取消时回滚库存、退款时触发 `reverse_split_on_refund` 并核对账务回退；发货后触发自动收货计时逻辑。
          3. 检查 updated_at 更新时间，并在必要时在 audit_log/account_flow/points_log 中查到对应记录。
        - SQL 验证: SELECT status,updated_at FROM orders WHERE order_number='...'; SELECT * FROM account_flow WHERE biz_no='...' AND type IN ('refund','reverse');

      - 守护任务验证（自动取消/自动收货）
        - 场景: 触发条件
          1. 存在 orders.status='pending_pay' 且 expire_at <= NOW() 时，守护线程应将其取消（status -> cancelled 或相应值），并回滚库存与预占资金。
          2. 存在 orders.status='pending_ship' 且 auto_recv_time <= NOW() 时，守护线程应将其设为 `completed` 并记录变更。
        - 验收步骤: 模拟或创建符合条件的订单，等待守护线程运行后，检查 orders/status、product_skus.stock、account_flow 及 refund/settle 相关记录。

      - 库存与并发约束验证
        - 场景: 高并发下多用户抢购同一 SKU
        - 验收步骤: 同时发起多笔下单请求，验证最终 `product_skus.stock` 不小于0，且成功订单的数量与库存扣减一致；若库存不足，响应应返回明确错误并不创建订单。

      - 资金拆分与结算（创建/支付流程）
        - 验收点: `split_order_funds` 在创建时触发（预留/分账状态）；`FinanceService.settle_order` 在支付时完成实际结算。通过查询 `account_flow`、`fund_pools` 或平台/商家子账户变动验证分账正确性（金额合计等于订单总额减去折扣）

      - 退款流程（参考退款模块）
        - 验收点: 用户申请退款后，审核通过应调用 `reverse_split_on_refund` 并将资金按原路退回；核对 account_flow、order status、refund record 三者一致

      - 性能与 SLO
        - 下单响应目标: ≤1s（常规场景）；支付回调整体处理（结算+状态变更）目标 ≤2s（依外部支付网关而异）


- **模块**: 商品管理
  - **子功能细化表**:

| 功能模块 | 子功能                   | 功能描述                                                              | 验收标准                                                                                           | 优先级 | 备注                                                                                                                                             |
| ---- | --------------------- | ----------------------------------------------------------------- | ---------------------------------------------------------------------------------------------- | --- |------------------------------------------------------------------------------------------------------------------------------------------------|
| 商品管理 | 商品列表（分页）              | 支持按分类/状态/商家/关键字分页查询，返回商品摘要与第一条SKU                                 | 分页正确，筛选条件生效；查询响应≤1s（常规数据量）                            | 高   | 支持页码/大小限制，最大100/页                                                                                                                              |
| 商品管理 | 商品详情                  | 返回商品所有字段、SKUs、属性、图片、商家信息、销售数据                                     | 字段无缺失；SKU 中 price/original\_price/stock/specifications 正确；图片能访问                                | 高   | 接口需兼容旧字段格式（main\_image 字符串或 JSON 列表）；                                                                                                          |
| 商品管理 | 商品搜索                  | 支持模糊搜索（名称/描述/SKU/拼音/分类/商家），按关键词拆词检索                               | 搜索结果相关度合理；支持多词 AND 策略；返回去重列表；响应≤1s（小量）                                                         | 高   | 支持拼音、商家名检索；**【新增】**&#x4EC5;搜索 is\_merchant=1 的认证商家，避免搜索到普通用户                                                                                   |
| 商品管理 | 新增商品                  | 支持创建商品及多 SKU、attributes；会员商品强制价格策略                                | 输入校验（分类/状态/SKU 字段）通过；创建后可查询到新商品及 SKUs；事务提交无残留；**【新增】**&#x70;inyin 字段根据商品名称自动生成，不可手动指定          | 高   | 支持 max\_points\_discount 字段；**【修改】**&#x8FD0;费(freight)系统强制为0；**【修改】**&#x4F1A;员商品SKU价强制为1980，忽略传入值；**【新增】**&#x73;pecifications 自动序列化为 JSON 字符串存储 |
| 商品管理 | 更新商品（含SKU）            | 支持更新商品基础信息、SKU 列表（整体替换模式）、attributes；会员商品价格灵活控制                   | 更新后查询一致；更新后查询一致;SKU更新需幂等;会员商品价格按照规则强制或可用接口覆盖                               | 中   | **【修改】**&#x4F1A;员商品价格策略：未提供SKU参数时统一改为1980，提供SKU参数时按传入值更新；**【新增】**&#x73;pecifications 更新时自动序列化为 JSON 字符串                                        |
| 商品管理 | SKU 管理                | **【修改】**&#x53;KU 无独立增删接口，通过商品更新接口全量替换管理；支持改、库存与价格、规格字段（JSON）      | SKU 数据校验；库存为非负整数；价格 ≥0；更新后对外展示一致；**【修改】**&#x89C4;格字段为 JSON 字符串存储                               | 高   | SKU 必须指向 product\_id；**【新增】**&#x6F;riginal\_price 和 specifications 字段支持                                                                        |
| 商品管理 | 图片上传与处理               | 支持详情图/轮播图上传、裁剪、压缩、追加策略，保存到 `pic_data/分类/商品ID/`                    | 支持 JPG/PNG/WEBP；单图大小限制（详情≤3MB、Banner≤5MB）；上传后返回可访问 URL；处理耗时合理                                  | 中   | 使用 Pillow 处理                                                                                                                                   |
| 商品管理 | 图片管理（删除）              | 支持删除指定图片并同步删除文件与 Banner 表记录                                       | 删除后数据库与文件系统一致；**【修改】**&#x8F6E;播图删除时同步删除 banner 表对应记录；**【新增】**&#x81EA;动移除/pic/前缀并删除物理文件；接口返回删除结果 | 中   | 物理文件路径以 `/pic/` 前缀约定                                                                                                                           |
| 商品管理 | 图片管理（追加更新）            | **【新增】**&#x652F;持追加式更新图片（不覆盖原有），通过 image\_type 明确区分轮播图/详情图        | 追加后图片列表完整；原有图片不受影响                       | 中   | **【新增】**&#x72EC;立 PUT `/products/{id}/images` 接口实现追加功能，通过 image\_type 参数区分类型                                                                   |
| 商品管理 | 轮播图/Banner 管理         | 管理商品 Banner 列表、状态与排序；**【新增】**&#x67E5;询商品关联的所有轮播图                  | Banner 列表查询正确；**【修改】**&#x65B0;增/追加 Banner 时同步插入 banner 表；轮播图显示顺序正确                             | 低   | Banner 支持上下架与排序字段；**【新增】**&#x47;ET `/banners` 接口支持按 product\_id 筛选                                                                             |
| 商品管理 | 库存管理                  | SKU 库存管理、**【修改】**&#x4EE3;码未实现库存阈值报警，需依赖订单系统库存扣减逻辑                 | **【修改】**&#x5E93;存扣减由订单系统实现，商品模块仅存储当前库存值；并发扣减需订单系统保证不产生负库存                                      | 高   | 需与下单/退货流程联动；**【修改】**&#x5546;品模块自身无库存报警实现                                                                                                       |
| 商品管理 | 会员商品规则                | 支持标记会员商品、固定会员价1980、购买规则说明与权益描述            | 会员商品在接口中标识明确；会员价格生效并受限；购买规则展示正确                                                                | 中   | **【新增】**&#x47;ET `/products/{id}/rules` 接口返回会员价、规则说明；**【修改】**&#x4EF7;格策略：新增时强制1980，更新时根据是否提供SKU参数灵活处理                                          |
| 商品管理 | 商品上下架与状态管理            | 支持草稿/上架/下架/缺货等状态变更并影响展示                                           | 上下架变更生效即时；下架商品不出现在搜索/列表                                                                        | 高   | 状态变更需权限控制；**【新增】**&#x73;tatus 字段支持 0=草稿 1=上架 2=下架 3=缺货                                                                                         |
| 商品管理 | 商品销售统计                | 提供单品销售量/销售额统计（仅已支付或已完成订单）                                         | 统计口径明确（仅计已支付或已完成订单）；查询结果与财务报表一致                                                                | 中   | 查询性能可异步或缓存；**【新增】**&#x47;ET `/products/{id}/sales` 接口返回 qty 和 sales                                                                            |
| 商品管理 | 权限与商家隔离               | 支持按 `user_id`（商家）管理商品，仅允许商家操作其商品                                  | 商家只能操作自己商品；管理端具备更高权限                                                                           | 中   | 支持后台审核/审批流；**【新增】**&#x67E5;询列表支持按 user\_id 筛选；**【新增】**&#x641C;索商家时仅匹配 is\_merchant=1 的用户                                                       |
| 商品管理 | **【新增】**&#x5546;品分类依赖 | **【新增】**&#x5546;品分类来自 `core.config.CATEGORY_CHOICES` 配置，无独立分类管理接口 | 分类值必须在配置列表中；创建/更新商品时校验分类有效性                                                                    | 中   | **【新增】**&#x5206;类配置硬编码，需修改代码才能变更分类                                                                                                             |
| 商品管理 | **【新增】**&#x8FD0;费固定策略 | **【新增】**&#x7CFB;统强制所有商品运费为0，freight 字段写入和更新均固定为0.00               | freight 字段在任何操作中保持为0；数据库值与实际策略一致                                                               | 低   | **【新增】**&#x50;ydantic 模型中 freight 字段有 le=0 限制，确保值为0                                                                                            |

  - **验收表**：

    - 商品模糊搜索 — GET `/api/products/search?keyword=手机`
      - 请求示例: GET `/api/products/search?keyword=手机`
      - 期望响应: 200 -> {"status":"success","data":[{"id":1,"name":"手机A","merchant_name":"店铺X"}]}
      - 验收步骤:
        1. 单关键词与多关键词（以空格分隔）均能正确返回结果，且多词为 AND 逻辑。
        2. 对中文进行拼音检索，拼音大写/小写均可命中。
        3. 当没有匹配时返回空数组而非错误。
        4. 限制返回不超过 200 条结果。
      - SQL 验证:
        - 检查 products 与 product_skus 的 JOIN 查询返回与接口一致：SELECT p.id,p.name FROM products p INNER JOIN product_skus ps ON ps.product_id=p.id WHERE p.name LIKE '%手机%';
      - 异常用例: 关键字为空或仅空白应返回空数组；长关键字不应导致服务器 500。

    - 商品列表分页 — GET `/api/products`
      - 请求示例: GET `/api/products?page=1&size=10&category=数码&status=1&user_id=12`
      - 期望响应: 200 -> {"status":"success","total":123,"page":1,"size":10,"data":[...]}
      - 验收步骤:
        1. 验证分页参数 `page`/`size` 生效；`size` 上限 100。
        2. 分类/状态/商家筛选生效，返回总数 `total` 与当前页 `data` 一致。
        3. 查询性能在常规数据量下 ≤1s。
      - SQL 验证: SELECT COUNT(*) FROM products WHERE category='数码' AND status=1 AND user_id=12; SELECT * FROM products WHERE category='数码' LIMIT 10 OFFSET 0;
      - 异常用例: 非法 page/size 返回 422 或合理默认值。

    - 查询单个商品 — GET `/api/products/{id}`
      - 请求示例: GET `/api/products/123`
      - 期望响应: 200 -> {"status":"success","data":{...包含 skus/attributes...}}
      - 验收步骤:
        1. 返回字段包含 `id,name,main_image,detail_images,skus,attributes,merchant_name` 等。
        2. `skus` 中每条包含 `id,sku_code,price,original_price,stock,specifications` 且数值类型正确（price/original_price 为数字，stock 为整数）。
        3. detail_images 若为字符串 JSON，应被解析为数组。
      - SQL 验证: SELECT * FROM products WHERE id=123; SELECT * FROM product_skus WHERE product_id=123; SELECT * FROM product_attributes WHERE product_id=123;
      - 异常用例: 商品不存在返回 404；异常 JSON 解析时仍应返回合理默认值而非 500。

    - 新增商品 — POST `/api/products`
      - 请求示例 (JSON): {"name":"新商品","category":"数码","skus":[{"sku_code":"A1","price":199.9,"stock":10}],"max_points_discount":10.0}
      - 期望响应: 200/201 -> 返回创建的商品 id 或成功消息
      - 验收步骤:
        1. 提交有效 payload 时创建 products、product_skus、product_attributes（若有），事务提交。
        2. `pinyin` 字段自动生成且不允许外部覆盖；`freight` 强制写 0.00。
        3. 对于会员商品，校验 is_member_product 与价格/规则约束。
      - SQL 验证: SELECT * FROM products WHERE id=<<new_id>>; SELECT * FROM product_skus WHERE product_id=<<new_id>>;
      - 异常用例: 非法分类返回 422；重复 SKU CODE 或缺失必需字段返回 400；事务回滚验证。

    - 更新商品（含 SKU 更新） — PUT `/api/products/{id}`
      - 请求示例: PUT `/api/products/123` payload 包含更新字段与可选 `skus` 数组（支持 SkuUpdate 模式）
      - 期望响应: 200 -> 更新成功
      - 验收步骤:
        1. 提供 skus 时按 SkuUpdate 执行局部更新；未提供 skus 时按规则处理会员价格（如文档所述）。
        2. 更新应为幂等，且外部可见数据与 DB 一致。
      - SQL 验证: SELECT * FROM products WHERE id=123; SELECT * FROM product_skus WHERE product_id=123;
      - 异常用例: 非法 status 值或分类返回 400；SKU 更新时 id 不存在返回 404 或局部失败。

    - 上传商品图片 — POST `/api/products/{id}/images`
      - 请求示例: multipart/form-data 上传 `detail_images`、`banner_images` 文件列表
      - 期望响应: 200 -> 返回处理后的图片 URL 列表
      - 验收步骤:
        1. 支持 JPG/PNG/WEBP；单图限制：详情图≤3MB，轮播图≤5MB；数量限制按接口说明（最多10张等）。
        2. 图片处理（裁剪/压缩）成功并写入文件系统 `pic_data/分类/商品ID/`，数据库保存对应 URL。
      - SQL 验证: 检查 banner/detail 字段或 banner 表记录是否包含新 URL；检查文件存在于磁盘。
      - 异常用例: 非法文件类型或超大文件返回 400；部分图片失败时需返回失败明细而非 500。

    - 轮播图查询 — GET `/api/banners`
      - 请求示例: GET `/api/banners` 或 `?product_id=123`
      - 期望响应: 200 -> {"status":"success","data":[...]} 并按 product_id 过滤
      - 验收步骤: 校验按 product_id 筛选返回对应 banner；无 product_id 返回全部可见 banners。
      - SQL 验证: SELECT * FROM banner WHERE product_id=123;

    - 商品销售数据 — GET `/api/products/{id}/sales`
      - 请求示例: GET `/api/products/123/sales`
      - 期望响应: 200 -> {"status":"success","data":{"total_quantity":X,"total_sales":Y}}
      - 验收步骤: 统计仅包含订单状态为已支付或已完成的订单（pending_ship/pending_recv/completed），并与 order_items/order 表数据一致。
      - SQL 验证: SELECT SUM(oi.quantity) AS qty, SUM(oi.total_price) AS sales FROM order_items oi INNER JOIN orders o ON oi.order_id=o.id WHERE oi.product_id=123 AND o.status IN ('pending_ship','pending_recv','completed');

    - 删除图片 — DELETE `/api/products/{id}/images`
      - 请求示例: DELETE `/api/products/123/images?image_urls[]=...&image_type=detail`
      - 期望响应: 200 -> 返回删除结果
      - 验收步骤: 删除后数据库相应字段/记录移除，物理文件从磁盘删除（或标记删除）；接口返回已删除 URL 列表。
      - 异常用例: 指定 URL 不存在返回合理提示；无权限删除返回 403。

    - 追加更新图片 — PUT `/api/products/{id}/images`
      - 请求示例: PUT multipart 上传文件并传 `image_type=banner` 或 `detail`
      - 期望响应: 200 -> 返回追加后的图片列表
      - 验收步骤: 新图片追加入库不覆盖原有图片；返回包含原图与新增图。

    - DTO/字段兼容性与验证点
      - 验收点: `PRODUCT_COLUMNS` 中新增 `max_points_discount` 能被查询与写入；`original_price` 与 `specifications` 在 SKU 层生效；`freight` 始终为 0.00。
      - SQL 验证: SHOW COLUMNS FROM products LIKE 'max_points_discount'; SELECT original_price FROM product_skus WHERE id=...;

    - 性能与 SLO
      - 商品列表/详情/搜索常规负载下响应目标 ≤1s；图片上传单图处理 ≤3s；批量导出（<=10k 条） ≤30s（异步优先）。



- **模块**: 财务系统
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---:|---:|---|
    | 支付接入与回调 | 支付回调、幂等与重放 | 支持支付渠道回调处理、幂等校验、回放日志 | 回调幂等；支付成功触发结算；沙箱测试通过 | 高 | 需商户证书、回调域名白名单；记录回放/死信 |
    | 交易结算与分账 | 订单结算、资金拆分 | 根据配置把实际支付金额分配到平台/补贴/公益/公司积分等池子，并写 `account_flow` | 分配守恒；账本可回溯；并发无负余额 | 高 | 配置化可调整；注意 Decimal 精度与并发锁 |
    | 退款与回退 | 逆向分账与积分回退 | 部分/全额退款时回退对应资金、积分、修正流水 | 退款后各方余额与流水一致；支持重入 | 高 | 支持部分退款；保留原分账 trace_id 以便回冲 |
    | 提现与打款 | 提现申请、审核、打款、税费 | 提现扣减余额/生成流水、打款回调更新状态 | 提现流程幂等；打款状态可追溯 | 高 | 合规/税务字段必填；支持人工复核与重试 |
    | 资金池治理 | 池子配置、初始化与调整 | 多资金池管理、配置化分配比例、审计变更 | 配置生效并写审计；分配合规 | 高 | 变更需审计与权限控制 |
    | 账本与对账 | 账本/流水记录与对账脚本 | 所有余额变更写 `account_flow` 和 `points_log`（4位小数），提供对账导出 | 账本可复现余额；对账脚本通过抽样验证 | 高 | 导出 CSV/Excel；流水保留期示例：1 年 |
    | 积分与奖励 | 积分发放、抵扣、推荐/团队奖励 | 会员积分发放、抵扣精度到小数、奖励创建与审核 | 积分精度正确；奖励可审核并发放；发放可回滚 | 中 | 积分使用 Decimal(4) 精度；发放伴随通知 |
    | 补贴与定时发放 | 周补贴、联创分红发放流程 | 发放预览、批量发放、异步/定时任务 | 预览与实际一致；任务幂等 | 中 | 任务幂等，支持发放预览与人工调整 |
    | 报表与导出 | 财务总览、池子、提现、退款、积分流水 | 支持分页/导出/权限控制 | 报表与账本一致；导出性能满足合同 | 中 | 权限分级导出；支持异步导出与通知 |
    | 风险与审计 | 异常检测、告警、人工工单 | 短款/重复记账/异常打款告警与工单 | 异常生成工单并可追踪；审计链完整 | 高 | 接入告警渠道并生成工单；支持人工复核与平账 |

  - **验收要点（必读）**:

    - 所有涉及余额变更的接口必须在同一事务内写入 `account_flow`，并在同一 cursor/连接上读取 `balance_after`。
    - 所有金额与积分使用 `Decimal`，`points_log` 支持 4 位小数，严禁使用 float 计算。
    - 关键失败应抛出 `FinanceException` 或明确定义的错误，让上层路由返回明确的 4xx/5xx 响应。
    - 所有外部回调（支付/退款）需实现幂等键、重试队列与每日回放日志，确保未出现重复分账。
    - 报表与对账用例需包含导出样例和对账脚本/SQL，便于财务核对。

  - **验收表**:

    - 初始化数据库 — POST `/api/init`
      - 请求示例: POST `/api/init`
      - 期望响应: 200 -> 成功消息（初始化完成）
      - 验收步骤: 执行后 DB 初始化脚本执行成功，必要表与默认数据存在；可重复调用（幂等或安全提示）。
      - SQL 验证: 检查关键表存在与版本（示例：SHOW TABLES LIKE 'users'; SELECT COUNT(*) FROM products LIMIT 1）。

    - 查询当前积分值 — GET `/api/subsidy/points-value`
      - 请求示例: GET `/api/subsidy/points-value`
      - 期望响应: 200 -> {"points_value": 0.01}
      - 验收步骤: 返回浮点数且在合理区间（0-0.02）；当未配置时返回默认值或 null。
      - SQL 验证: 检查配置表或 fund_pools/subsidy 配置记录。

    - 调整积分值 — POST `/api/subsidy/points-value/adjust`
      - 请求示例: POST `/api/subsidy/points-value/adjust?points_value=0.01&auto_clear=true`
      - 期望响应: 200 -> 调整成功
      - 验收步骤: 写入手动调整值并在下一次发放后按 auto_clear 行为自动清除（若 auto_clear=true 则发放后清除）。
      - 异常用例: 超出允许区间（>0.02）返回 422。

    - 发放周补贴（手动触发） — POST `/api/subsidy/distribute`
      - 请求示例: POST `/api/subsidy/distribute`
      - 期望响应: 200 -> 发放结果/汇总
      - 验收步骤: 触发后生成对应 points_log/award 记录，受益用户列表与金额合计正确；支持幂等或具备防重策略。
      - SQL 验证: SELECT * FROM points_log WHERE reason LIKE '%subsidy%' AND created_at>=...;

    - 清空指定资金池 — POST `/api/fund-pools/clear`
      - 请求示例: POST `/api/fund-pools/clear` body {"pool_types":["platform_revenue"]}
      - 期望响应: 200 -> 返回清空结果
      - 验收步骤: 指定资金池余额被置为0或转出到指定账户；操作需具备管理员权限并记录 audit_log。
      - SQL 验证: SELECT balance FROM fund_pools WHERE pool_type='platform_revenue';

    - 查询/更新资金池分配配置 — GET/POST `/api/fund-pools/allocations`
      - 请求示例: GET `/api/fund-pools/allocations`；POST `/api/fund-pools/allocations` body {"allocations": {"platform":0.2,"merchant":0.8}}
      - 期望响应: 200 -> 当前或更新后的分配配置
      - 验收步骤: 更新后各池占比合计为1；更新记录写入配置表并可回滚。

    - 发放联创分红（预览/调整/执行） — GET `/api/reports/unilevel/preview`, POST `/api/unilevel/adjust`, POST `/api/unilevel/dividend`
      - 请求示例: GET `/api/reports/unilevel/preview`；POST `/api/unilevel/adjust?amount_per_weight=5.0`；POST `/api/unilevel/dividend`
      - 期望响应: 200 -> 预览数据/调整确认/执行结果
      - 验收步骤: 预览接口返回按权重计算的分红预估；调整接口能设置每权重金额；执行接口能按当前设置生成分发记录且写入 account_flow 并减相应资金池余额。
      - SQL 验证: SELECT * FROM reward_logs WHERE biz_type='unilevel' AND week=...; SELECT balance FROM fund_pools WHERE pool_type='unilevel_pool';

    - 预存补贴资金 — POST `/api/subsidy/fund`
      - 请求示例: POST `/api/subsidy/fund?amount=10000`
      - 期望响应: 200 -> 资金入池成功
      - 验收步骤: 资金池余额增加，产生 account_flow 入账记录；权限校验。

    - 公益基金余额与流水 — GET `/api/public-welfare`, GET `/api/public-welfare/flow`
      - 请求示例: GET `/api/public-welfare`; GET `/api/public-welfare/flow?limit=50`
      - 期望响应: 200 -> 余额/流水列表
      - 验收步骤: 余额与流水合计一致，流水能分页返回。

    - 审核提现 — PATCH `/api/withdrawals/audit`
      - 请求示例: PATCH `/api/withdrawals/audit` body {"withdrawal_id":123,"action":"approve"}
      - 期望响应: 200 -> 审核通过或拒绝结果
      - 验收步骤: 审核后触发资金划转或拒绝并回退；生成 account_flow 与 audit_log；错误场景返回明确原因。

    - 奖励查询与流水 — GET `/api/rewards/pending`, GET `/api/rewards/flow`
      - 请求示例: GET `/api/rewards/pending?status=pending&limit=50`
      - 期望响应: 200 -> 奖励列表/流水
      - 验收步骤: 列表分页、状态筛选有效；奖励发放后状态更新，相关流水入账。

    - 优惠券发放/使用 — POST `/api/coupons/distribute`, POST `/api/coupons/use`
      - 请求示例: POST `/api/coupons/distribute?user_id=123&amount=10`；POST `/api/coupons/use?coupon_id=55&user_id=123`
      - 期望响应: 200 -> 发放/使用结果
      - 验收步骤: 发放后 coupons 表存在记录；使用后标记已用且不可重复；财务结算中计入 coupon_discount 字段。
      - SQL 验证: SELECT * FROM coupons WHERE id=55; SELECT used FROM coupons WHERE id=55;

    - 各类报表接口（周/月/合并报表/流水类） — `/api/reports/*`
      - 验收步骤: 代表性报表按给定时间范围返回正确聚合数据；分页与导出（若支持）正确；对账脚本能以 SQL 重现报表数据。
      - SQL 验证: 提供对应报表的关键 SQL（例如周补贴汇总、资金流水聚合）并与接口返回一致。

    - 性能与 SLO
      - 财务关键接口（init、settle、audit）在测试环境目标响应：init ≤30s（DB 初始化），settle/audit ≤2s（视外部支付/转账而定）；报表导出 ≤30s（<=10k 行，异步优先）。

- **模块**: 系统/平台管理
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 系统/平台管理 | 系统配置管理 | 提供可视化/接口化的系统全局配置项管理（如站点信息、邮件/短信、第三方密钥、限流阈值） | 配置修改即时生效或按说明重载；可通过接口读取当前配置；配置变更有审计记录 | 高 | 支持导入/导出配置，权限控制 |
    | 系统/平台管理 | 轮播句/Banner 文案管理 | 管理首页轮播语句与轮播图语句（新增/修改/查询），缺少记录时自动创建占位 | 查询返回默认记录；更新后前端展示生效；接口返回最新数据 | 低 | 参见 `api/system/routes.py` 语句处理逻辑 |
    | 系统/平台管理 | 日志与审计 | 集中记录操作日志、系统错误日志、审计重要财务/管理员操作，并支持查询/导出 | 日志按级别写入文件/存储；审计记录包含操作者、时间、IP、变更前后值；支持按条件导出 | 高 | 日志滚动策略与保留期需约定（例如 90 天） |
    | 系统/平台管理 | 定时任务与守护进程 | 管理和监控定时任务（如订单过期取消、自动收货、周补贴发放），支持重试与幂等执行 | 定时任务按计划触发并完成预期动作；任务运行记录可查询；失败可重试且不产生重复副作用 | 中 | 需提供任务状态/日志界面 |
    | 系统/平台管理 | 管理员与权限管理 | 支持角色/菜单权限配置、多级管理员账号、权限即时生效与角色回收 | 权限变更后被限制的操作返回403；角色管理功能穩定无权限泄露 | 高 | 支持基于角色与基于资源的细粒度权限 |
    | 系统/平台管理 | 接口限流与防护 | 全局/接口级限流、IP 黑白名单、请求速率限制、简单防刷/反爬策略 | 达到限流阈值返回规范错误码；限流规则生效且可配置；异常流量告警触发 | 高 | 可与网关或中间件协作实现 |
    | 系统/平台管理 | 健康检查与监控 | 提供服务健康检查接口、Prometheus 指标、错误与性能告警 | 健康接口返回服务状态；指标覆盖CPU/内存/请求QPS/错误率；关键告警触达渠道 | High | 集成 Prometheus/Grafana 或类似监控系统 |
    | 系统/平台管理 | 文件与静态资源管理 | 管理静态目录、图片存储策略、CDN 配置、备份与清理策略 | 上传/访问静态资源正常；图片处理后可访问；定期清理策略有效 | 中 | 使用 `pic_data/` 路径约定，支持外部存储扩展 |
    | 系统/平台管理 | 运维与部署支持 | 部署脚本、迁移脚本、环境配置模板、回滚策略与灰度发布支持 | 按文档能快速部署/回滚；迁移脚本无数据丢失；灰度发布能按配置路由一部分流量 | 中 | 提供 `pyproject.toml` / 部署说明 |
    | 系统/平台管理 | 备份与恢复 | 数据库和关键文件定期备份、备份验证、恢复演练 | 备份任务完成率 100%；恢复演练成功并产出报告；恢复时间满足合同约定 | 高 | 备份保留期、恢复点 (RPO/RTO) 在合同中明确 |
    | 系统/平台管理 | 运维权限与变更审批 | 运维操作（如手工调账/数据修复/脚本执行）需审批并记录 | 运维变更有审批流程并记录；审批后操作可回溯且有回滚方案 | High | 高风险操作双人/多级审批 |
    | 系统/平台管理 | 多环境支持 | 支持独立的开发/测试/预发布/生产环境配置与数据隔离 | 各环境间配置与数据隔离；部署脚本支持多环境参数 | 中 | 环境配置示例提供在交付物中 |
    | 系统/平台管理 | 系统通知与消息 | 提供邮件/短信/站内信模板管理与发送接口，支持任务异步发送与失败重试 | 模板可配置；发送记录可查询；发送失败自动重试并告警 | Medium | 需对接短信/邮件服务商 |
    | 系统/平台管理 | 运维自助工具 | 提供常用运维工具（清理缓存、重跑任务、导出日志、手动触发作业） | 工具权限受限；执行后产生可审计记录；工具操作正确无副作用 | Low | 仅限管理员使用 |

  - **验收表**:

    - 获取系统标语 — GET `/api/system/sentences`
      - 请求示例: GET `/api/system/sentences`
      - 期望响应: 200 -> {"status":"success","data":{"id":1,"banner_sentence":"欢迎","system_sentence":"在线商城","created_at":...,"updated_at":...}}
      - 验收步骤:
        1. 当表中存在记录时返回最新一条（按 id 倒序）；字段 `banner_sentence` 与 `system_sentence` 至少返回空字符串而非 null。
        2. 若表为空，接口应自动创建一条默认记录并返回（验证自动创建逻辑）。
        3. 返回字段格式稳定，响应码为 200，响应时间目标 ≤500ms（常规环境）。
      - SQL 验证:
        - SELECT id,banner_sentence,system_sentence,created_at,updated_at FROM system_sentence ORDER BY id DESC LIMIT 1;
        - 若表为空，调用后应能查询到新插入的记录（cur.lastrowid 可验证）。
      - 异常用例: 数据库异常时返回 500，且日志记录明确（检查服务日志）。

    - 更新系统标语 — PUT `/api/system/sentences`
      - 请求示例 (JSON): {"banner_sentence":"新年快乐","system_sentence":"活动进行中"}
      - 期望响应: 200 -> {"status":"success","message":"系统标语已更新","data":{...更新后的记录...}}
      - 验收步骤:
        1. 当存在记录时，应更新最新一条记录并刷新 `updated_at`；当不存在记录时应创建新记录并返回。
        2. 若请求体中未包含任何可更新字段，应返回 400（接口中有相应校验）。
        3. 更新后再次调用 GET `/api/system/sentences` 能读取到最新值。
        4. 操作应写入数据库并提交事务（可重复调用，但保持幂等性在合理范围内）。
      - SQL 验证:
        - SELECT banner_sentence,system_sentence,updated_at FROM system_sentence WHERE id=<<returned_id>>;
        - 校验 `updated_at` 比更新前的时间晚且字段值匹配请求体。
      - 异常用例: 提交空体或非 JSON 返回 400；数据库写入失败返回 500 并回滚。

三、非功能要求（详化）

- **性能（Performance）**:
  - 常规 API 响应: 95% 请求 ≤ 1s，平均响应 ≤ 500ms，P99 ≤ 3s。
  - 关键业务:
    - 下单（POST /api/order/create）响应目标 ≤ 1s（常规场景）；并发抢购场景保证库存不出现负值。
    - 支付结算（FinanceService.settle_order）目标 ≤ 2s（受第三方支付网关影响，需记录外部延迟）。
    - 报表导出（<=10k 行）目标 ≤ 30s（异步导出优先）。
    - 图片单文件上传与处理（裁剪/压缩）目标 ≤ 5s。

- **并发与扩展性（Scalability & Concurrency）**:
  - 基线支持：1000 并发活跃用户（可按合同扩容到 5000+，通过水平扩容与读写分离实现）。
  - 应用层可水平扩容，使用负载均衡；数据库建议主从复制与只读副本用于报表/查询；静态资源使用对象存储+CDN。

- **可用性与 SLA（Availability）**:
  - 目标 SLA：99.5%（按月计算）。
  - 提供健康检查 `/health`、就绪检查 `/ready`；可在负载均衡中用于流量切换。
  - 允许计划内维护窗口并提前通知甲方。

- **安全（Security）**:
  - 传输层：强制 TLS1.2+。所有外部 API 与回调使用 HTTPS。
  - 身份与权限：密码使用 `bcrypt` 存储；API 使用 JWT 或其他 token 鉴权；管理员/运维操作使用 RBAC，敏感操作需二次校验（admin_key/审批）。
  - 秘钥管理：所有密钥/凭证放在运行时环境变量或秘密管理服务（如 Vault），不得硬编码在源码中。
  - 数据保护：敏感字段（身份证、银行卡号等）至少采用字段级加密（AES），备份加密存储。
  - 注入防护：所有 DB 操作使用参数化查询或内部封装的表访问工具（见 `core/table_access.py`）；对外输入严格校验。
  - 速率限制/防刷：API 网关/中间件实现全局与接口级限流，异常流量触发告警并返回规范错误码。

- **数据完整性与一致性（Data Integrity）**:
  - 所有涉及资金/余额变更的操作必须保证事务语义，写入 `account_flow` 与 `points_log` 与业务操作在同一事务或通过可靠补偿机制完成。
  - 金额与积分计算使用 `Decimal` 精度控制（至少 4 位小数），严禁使用浮点运算。

- **备份与恢复（Backup & Recovery）**:
  - 备份策略：每日逻辑备份（dump）+ 每周全量备份；备份加密存储，保留周期 30 天（或合同约定）。
  - RPO（恢复点目标）：24 小时；RTO（恢复时间目标）：≤ 4 小时（生产环境）。
  - 定期恢复演练：至少季度一次，演练报告归档。

- **监控、日志与告警（Monitoring & Logging）**:
  - 指标：Prometheus 指标采集（请求 QPS/延迟/P95/P99/错误率），并配套 Grafana 仪表盘。
  - 日志：业务错误与审计日志分离写入文件/集中日志系统（ELK/EFK），关键操作（管理员、财务）必须写审计日志（包含操作者、时间、IP、变更前后值）。
  - 告警策略：错误率>1%/分钟、支付失败率>0.5%、数据库连接异常、备份失败等触发告警并通报负责人。

- **运维与部署（Operations & CI/CD）**:
  - 提供 CI 流水线（Lint/Test/Build）与自动化部署脚本（示例:`docker-compose`/`systemd` 单元）；提供迁移脚本（DDL）并在变更前备份。
  - 健康检查与滚动升级支持，灰度发布与回滚方案需文档化。

- **合规与审计（Compliance）**:
  - 关键财务/提现/调账操作需审计与审批链路（支持导出审计 CSV）。
  - 合规字段（税号、发票信息等）按法规要求留痕并加密存储。

- **性能测试（Validation）**:
  - 在验收前由乙方提供性能测试报告（包含并发场景、关键接口 QPS/延迟分布），并在测试环境复现主要 SLO。

- **灾备（DR）与故障恢复**:
  - 支持至少一个异地备份点；关键故障恢复手册包含故障检测、切换、回滚流程与联络清单。

- **运维手册（Runbook）示例要点**:
  - 常用命令示例：数据库备份/恢复、日志定位、重启服务、清理图片缓存等。
  - 快速恢复示例（MySQL 恢复的高层步骤）：
    - 恢复逻辑备份：`sudo mysql -u root -p < dump.sql`。
    - 恢复 binlog（如启用）：按时间点应用 binlog。

附注：以上为建议的非功能要求模板，最终数值（并发、SLA、RPO/RTO、保留期等）应在合同中以双方确认的数值替换。

四、验收与变更规则（模板）

- **验收标准**：按清单“验收标准”项逐条测试，单项通过后标注为“已通过”；整体通过率 100% 为合格交付。
- **验收流程**：
  1. 乙方完成开发并提交测试环境；
  2. 甲方在约定时间内（例如 10 个工作日）完成功能验证并提交问题清单；
  3. 乙方在约定修复周期内修复并提交复测；
  4. 双方确认全部条目通过后签署验收单。
- **变更流程**：任何功能增删改均需双方签署《需求变更确认单》，变更同时调整工期与费用。
- **缺陷分级与响应时限**：
  - 紧急（P0）：系统不可用/关键业务中断，响应 ≤ 2 小时，修复或临时解决方案 ≤ 24 小时；
  - 高（P1）：主要功能受影响，响应 ≤ 8 小时，修复或规避措施 ≤ 3 个工作日；
  - 中（P2）：次要功能/界面问题，响应 ≤ 2 个工作日，修复 ≤ 10 个工作日；
  - 低（P3）：建议性改进，双方另行评估排期。

五、交付物与交付标准

- **交付物清单**：源代码（含注释）、部署脚本、依赖清单（pyproject.toml）、数据库初始化脚本、接口文档（OpenAPI）、部署手册、用户手册、测试报告
- **交付标准**：代码能在目标环境按文档部署并启动，接口文档与实际接口一致，关键用例通过测试

六、验收交付时间与里程碑（示例）

- **里程碑1**：需求确认与技术评估 — 日期
- **里程碑2**：开发完成（测试环境） — 日期
- **里程碑3**：甲方测试与问题修复 — 日期
- **里程碑4**：验收与生产部署 — 日期

七、知识产权与源码交付（简要）

- **代码归属**：按主合同约定。若合同约定源码交付，则乙方应提供完整源码与构建说明。
- **第三方组件**：列明所有第三方依赖及许可证，若有商业授权需由甲方另行购买。

八、签署确认

- 甲方（盖章）：__________  代表签字：__________  日期：__________
- 乙方（盖章）：__________  代表签字：__________  日期：__________

