附件编号：[附件一]
文件名称：《[软件名称] V[版本号] 功能清单》
合同关联：本清单为《[合同全称]》（合同编号：[编号]）不可分割部分，与主合同具有同等法律效力。

一、基础信息

- **软件名称**: :
- **版本号**: :
- **交付环境**: :
- **清单版本**: :
- **生效日期**: :

二、功能模块清单（总纲）

- **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 用户管理 | 账号注册 | 支持手机号+验证码注册，必填字段：手机号、密码、姓名（推荐码可选） | 手机号格式校验；验证码有效期5分钟；手机号唯一；创建成功返回 user_id；接口响应≤500ms | 高 | 需对接短信API |
    | 用户管理 | 登录认证 | 账号密码登录、支持微信小程序一键登录，返回 JWT token（有效期1天） | 密码校验通过；失败计数锁定策略生效（示例：连续5次失败锁定10分钟）；登录成功返回 token 与用户信息；接口响应≤500ms | 高 | 支持 refresh token |
    | 用户管理 | 权限控制 | 按角色（管理员/普通用户）分配菜单与操作权限，支持后台管理权限配置 | 权限配置即时生效；无越权访问；不同角色访问受限接口返回 403；权限变更生效时间≤1分钟 | 中 | 权限表可配置扩展 |
    | 用户管理 | 用户信息维护 | 支持修改昵称、手机号、头像、密码、个人资料 | 修改后返回最新用户信息；字段校验生效；密码修改需原密码或验证码验证；接口响应≤500ms | 中 | 头像通过专门接口上传 |
    | 用户管理 | 地址管理 | 收货地址增/删/改/查、设为默认、退货地址管理 | 默认地址唯一；地址录入带省市区校验；接口返回地址列表且分页；设置默认时原默认取消 | 中 | 地址与用户系统统一管理（见 services/address_service.py） |
    | 用户管理 | 头像上传 | 支持图片上传、裁剪、压缩，返回可访问 URL | 支持 jpeg/png；文件大小≤2MB；图片处理成功并返回 URL；访问权限正确 | 低 | 使用 Pillow 处理，存储到 `pic_data/` |
    | 用户管理 | 密码找回 | 短信验证码找回并重设密码，含强度校验 | 验证码有效且只能使用一次；新密码符合强度规则；操作有记录和时戳 | 高 | 需短信 API 集成 |
    | 用户管理 | 绑定推荐人 | 用户可通过推荐码或推荐人手机号绑定推荐人关系 | 推荐关系唯一且不可重复绑定；绑定后在用户信息中可见上级信息 | 低 | 绑定需防止循环引用 |
    | 用户管理 | 查询直推/团队 | 支持查询直推用户列表与团队列表（可递归至 N 层，默认6层） | 支持分页与筛选；返回层级与关系链；响应合理时间（示例≤1s） | 低 | 支持导出报表 |
    | 用户管理 | 用户列表与导出 | 管理端分页筛选用户并支持导出json | 筛选条件正确、导出数据完整性校验通过；导出文件格式正确，导出时间≤30s（小于10k条） | 中 | 导出需相应权限 |
    | 用户管理 | 冻结/注销 | 管理端冻结用户/用户自助注销（逻辑删除） | 冻结后不可登录、不可下单；注销为逻辑删除并保留必要数据（按保留期策略） | 高 | 注销需二次确认与备份 |
    | 用户管理 | 会员升级/设置等级 | 支持用户升级会员、后台调整等级 | 升级后权限/价格生效；历史变更记录保存；升级接口幂等 | 中 | 可能涉及支付或后台审批 |

  - **验收占位**: 每项功能在最终清单中需填入“功能描述 / 接口示例 / 验收标准（步骤） / 优先级 / 备注（对接/特殊权限/数据迁移）”。

- **模块**: 订单系统
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 订单系统 | 购物车管理 | 支持加入、移除、更新数量、批量勾选与清空；购物车与库存、商品上下架状态联动 | 加入/移除/更新接口响应≤500ms；选中状态正确影响结算；并发扣减前校验选中项库存；数据一致性经抽样检查通过 | 高 | 购物车接口应支持批量操作 |
    | 订单系统 | 订单创建 | 支持购物车结算与立即购买；地址/自提选项；生成唯一 `order_number`；库存校验与事务性写入订单与明细 | 创建成功返回 `order_number`；下单过程原子性（库存扣减、订单明细、分账在同一事务或补偿机制）；重复提交幂等处理；接口响应≤1s | 高 | 需考虑乐观/悲观锁策略 |
    | 订单系统 | 库存校验与扣减 | 下单时校验 SKU 库存并扣减，支持库存回滚（退款/取消） | 并发场景库存不出现负数；扣减与回滚日志完整；库存变更记录可审计 | 高 | 与 `product_skus` 表字段关联 |
    | 订单系统 | 支付对接 | 支持微信，处理支付回调并触发财务结算与订单状态变更 | 支付回调幂等；支付成功后结算逻辑（分账/积分/优惠）正确；回调异常重试策略；支付成功率指标（合同可填） | 高 | 需商户密钥与沙箱测试账号 |
    | 订单系统 | 积分与优惠券抵扣 | 在支付前校验并应用积分与优惠券，计算实际应付金额 | 抵扣计算正确、不能超额抵扣；抵扣并发安全；使用后状态变更不可重复使用 | 中 | 抵扣规则外放配置 |
    | 订单系统 | 订单状态流转 | 支持状态：`pending_pay`/`pending_ship`/`pending_recv`/`completed`/`refund`/`refunded` 等，提供管理员与用户端查询与变更接口 | 状态变更符合业务规则（例如支付后变为待发货）；状态更改幂等；通知/消息触发正确 | 高 | 发货后自动收货策略需明示 |
    | 订单系统 | 商家发货与快递跟踪 | 写入快递单号并变更状态，支持商家查询订单与批量发货 | 发货接口返回成功率高；跟踪号保存并可回溯；查询时包含订单商品明细 | 中 | 支持导出发货单 |
    | 订单系统 | 退款与退货管理 | 支持用户申请退款/退货、商家/平台审核、退货地址填写、退款回退资金处理 | 退款申请有唯一记录；审核后资金回滚（调用 reverse_split_on_refund）并验证账目平衡；退货地址必须在同意退货时提供 | 高 | 需要与财务模块对账 |
    | 订单系统 | 自动取消与自动收货 | 支持过期未支付自动取消；已发货过期自动确认收货（可配置天数） | 守护任务稳定运行；自动操作记录；取消/自动收货触发相应的库存或结算逻辑 | 中 | 存在守护线程/定时任务（见 order.py） |
    | 订单系统 | 订单查询与详情 | 支持按用户、订单号、状态、多条件查询；详情返回用户、地址、商品明细、支付与物流信息 | 列表支持分页与筛选；详情接口返回完整结构、字段无歧义；查询响应≤1s（小数据集） | 高 | 包含第一条商品摘要与规格 |
    | 订单系统 | 商家后台订单管理 | 商家可按状态查询、发货、审核退款、查看结算明细 | 权限隔离；商家操作仅作用于其订单范围；结算明细与流水一致 | 中 | 商家与平台权限需区分 |
    | 订单系统 | 报表与导出 | 支持按日/周/月导出销售报表、订单明细、退款统计 | 导出文件格式正确、数据完整；导出性能满足约定（示例：≤30s 小于10k条） | 低 | 可异步生成并通知下载 |

    - **验收占位**: 每项功能需补充“接口示例（URL/方法/请求体/响应示例）”、“验收步骤（逐条测试点）”、“性能与容错要求”、“边界与异常场景”。

- **模块**: 商品管理
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 商品管理 | 商品列表（分页） | 支持按分类/状态/商家/关键字分页查询，返回商品摘要与第一条SKU | 分页正确，筛选条件生效；返回字段完整；查询响应≤1s（常规数据量） | 高 | 支持页码/大小限制，最大100/页 |
    | 商品管理 | 商品详情 | 返回商品所有字段、SKUs、属性、图片、商家信息、销售数据 | 字段无缺失；SKU 中 price/original_price/stock/specifications 正确；图片能访问 | 高 | 接口需兼容旧字段格式（main_image 字符串或 JSON 列表） |
    | 商品管理 | 新增商品 | 支持创建商品及多 SKU、attributes；会员商品强制价格策略（例如 1980） | 输入校验（分类/状态/SKU 字段）通过；创建后可查询到新商品及 SKUs；事务提交无残留 | 高 | 支持 `max_points_discount` 字段 |
    | 商品管理 | 更新商品（含SKU） | 支持更新商品基础信息、SKU 列表（新增/更新/删除）、attributes；会员商品价格处理规则明确 | 更新后查询一致；SKU 更新需幂等；会员商品价格按照规则强制或可用接口覆盖 | 中 | 支持局部更新与批量 SKU 操作 |
    | 商品管理 | SKU 管理 | 支持 SKU 的增/删/改、库存与价格、规格字段（JSON） | SKU 数据校验；库存为非负整数；价格 ≥0；更新后对外展示一致 | 高 | SKU 必须指向 product_id |
    | 商品管理 | 图片上传与处理 | 支持详情图/轮播图上传、裁剪、压缩、追加与覆盖策略，保存到 `pic_data/分类/商品ID/` | 支持 JPG/PNG/WEBP；单图大小限制（详情≤3MB、Banner≤5MB）；上传后返回可访问 URL；处理耗时合理 | 中 | 使用 Pillow 处理，支持追加（非覆盖）|
    | 商品管理 | 图片管理（删除/更新） | 支持删除指定图片并同步删除文件与 Banner 表记录；支持追加式更新 | 删除后数据库与文件系统一致；Banner 表同步更新；接口返回删除结果 | 中 | 物理文件路径以 `/pic/` 前缀约定 |
    | 商品管理 | 商品搜索 | 支持模糊搜索（名称/描述/SKU/拼音/分类/商家），按关键词拆词检索 | 搜索结果相关度合理；支持多词 AND 策略；返回去重列表；响应≤1s（小量） | 高 | 支持拼音、商家名检索（见 routes.py） |
    | 商品管理 | 轮播图/Banner 管理 | 管理商品 Banner 列表、状态与排序 | Banner 列表查询正确；新增 Banner 同步插入 banner 表；轮播图显示顺序正确 | 低 | Banner 支持上下架与排序字段 |
    | 商品管理 | 库存与库存报警 | SKU 库存管理、支持库存阈值报警/预警 | 库存变更日志完整；并发扣减不产生负库存；报警触发正确 | 高 | 需与下单/退货流程联动 |
    | 商品管理 | 会员商品规则 | 支持标记会员商品、固定会员价、购买规则说明与权益描述 | 会员商品在接口中标识明确；会员价格生效并受限；购买规则展示正确 | 中 | 会员价示例：1980，见 ext.py get_product_rules |
    | 商品管理 | 商品上下架与状态管理 | 支持草稿/上架/下架/缺货等状态变更并影响展示 | 上下架变更生效即时；下架商品不出现在搜索/列表 | 高 | 状态变更需权限控制 |
    | 商品管理 | 商品销售统计 | 提供单品销售量/销售额统计（按日/周/月） | 统计口径明确（仅计已支付或已完成订单）；查询结果与财务报表一致 | 中 | 查询性能可异步或缓存 |
    | 商品管理 | 权限与商家隔离 | 支持按 `user_id`（商家）管理商品，仅允许商家操作其商品 | 商家只能操作自己商品；管理端具备更高权限 | 中 | 支持后台审核/审批流 |

    - **验收占位**：每项应补充“接口示例（URL/方法/请求/响应）”、“验收步骤（功能点与异常用例）”、“性能及并发要求（例如导出/搜索）”与“第三方依赖/注意事项（如图片存储、GD 库、权限）”。

- **模块**: 财务系统
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 财务系统 | 支付网关集成 | 集成微信支付渠道，支持订单支付、退款、异步回调 | 支付回调必须幂等；回调后订单状态与财务数据一致；异常回调可重试；支付成功率与 SLA 可协商 | 高 | 需提供商户证书/密钥与沙箱账号 |
    | 财务系统 | 订单结算与分账 | 按规则拆分订单资金到商家与各资金池（平台、补贴、公益等），记录 `account_flow` | 拆分金额与分配比例100%正确；拆分记录可查询且可回溯；结算在同一事务或有补偿机制 | 高 | 参见 `split_order_funds` 实现 |
    | 财务系统 | 退款回退与反向分账 | 退款时反向回退已分配资金并修正流水，支持部分退款与整单退款 | 退款后所有受影响账户余额与流水回退正确；对账结果可验证；与订单状态联动 | 高 | 需调用 `reverse_split_on_refund` 或等效流程 |
    | 财务系统 | 提现申请与审核 | 用户/商家发起提现、平台审核（自动/人工）、税费处理、打款流程 | 提现申请记录完整；审核通过后资金从对应池扣减；税费计算正确；提现状态可追踪 | 高 | 打款时限与到账时限在合同中明确（示例：24-72小时） |
    | 财务系统 | 资金池与账户管理 | 管理平台各资金池（如补贴池、公益池、平台收入池），支持账本式记录 | 资金池余额与流水一致；资产字段默认值处理（避免 NULL）；并发一致性保证 | 高 | 资金池需支持手动调账与备注 |
    | 财务系统 | 账户流水与对账 | 记录详细流水（类型、来源、目标、订单号），支持日/月对账、导出与自动对账 | 对账工具能校验账务平衡；差异率 0（或合同约定阈值）；导出格式满足财务要求 | 高 | 提供对账报告模板与导出接口 |
    | 财务系统 | 周补贴/奖励发放 | 定时/批量发放补贴或奖励，支持积分/优惠券二种形式 | 发放规则按配置执行；发放后流水与余额一致；支持回滚与手动调整 | 中 | 运行在独立定时任务（可重入/幂等） |
    | 财务系统 | 报表与对账报表 | 提供资金流水、提现、分账、退款、收益等多维报表（按日/周/月） | 报表数据与账本一致；导出格式正确；报表生成性能满足约定（可异步） | 中 | 支持按商家/平台/资金池分组查询 |
    | 财务系统 | 税费与发票处理 | 自动计算提现税率与应税项，支持开票信息记录与导出 | 税费计算逻辑正确；发票申请/开具流程可追踪；涉及税务合规文档 | Low | 税率可配置（例如 `core.config.TAX_RATE`） |
    | 财务系统 | 风险与异常处理 | 资金异常（短款/多付/重复记账）检测、告警与人工干预流程 | 异常检测规则生效；异常工单生成并可以人工平账；告警时效符合 SLA | 高 | 需接入告警渠道（邮件/钉钉/微信） |
    | 财务系统 | 接口与导出 | 对外提供安全的资金查询/流水导出/结算导出接口，供财务系统使用 | 接口权限控制；导出数据完整、格式符合财务系统要求；导出耗时可控 | 中 | 支持按时间段/账本类型筛选 |
    | 财务系统 | 审计日志与权限控制 | 关键财务操作（手工调账、审核、打款）需记录审计日志并限制权限 | 审计日志包含操作者、时间、变更前后值、原因；高权限操作需复核 | 高 | 保留期与日志导出策略需约定 |
    | 财务系统 | 资金备份与恢复 | 备份账本与关键流水，支持恢复演练与灾备 | 备份完整性校验；恢复时长与恢复点（RPO/RTO）在合同中约定 | 中 | 定期演练并提供恢复报告 |

  - **验收占位**: 每个子功能在最终清单中需补充“接口示例 / 接口权限 / 逐条验收步骤（含对账用例）/ 性能与时效要求（如提现审核时限、批量结算耗时）/ 异常回滚用例 / 第三方依赖（支付网关、银行接口）”。

- **模块**: 系统/平台管理
  - **子功能细化表**:

    | 功能模块 | 子功能 | 功能描述 | 验收标准 | 优先级 | 备注 |
    |---|---|---|---|---:|---|
    | 系统/平台管理 | 系统配置管理 | 提供可视化/接口化的系统全局配置项管理（如站点信息、邮件/短信、第三方密钥、限流阈值） | 配置修改即时生效或按说明重载；可通过接口读取当前配置；配置变更有审计记录 | 高 | 支持导入/导出配置，权限控制 |
    | 系统/平台管理 | 轮播句/Banner 文案管理 | 管理首页轮播语句与轮播图语句（新增/修改/查询），缺少记录时自动创建占位 | 查询返回默认记录；更新后前端展示生效；接口返回最新数据 | 低 | 参见 `api/system/routes.py` 语句处理逻辑 |
    | 系统/平台管理 | 日志与审计 | 集中记录操作日志、系统错误日志、审计重要财务/管理员操作，并支持查询/导出 | 日志按级别写入文件/存储；审计记录包含操作者、时间、IP、变更前后值；支持按条件导出 | 高 | 日志滚动策略与保留期需约定（例如 90 天） |
    | 系统/平台管理 | 定时任务与守护进程 | 管理和监控定时任务（如订单过期取消、自动收货、周补贴发放），支持重试与幂等执行 | 定时任务按计划触发并完成预期动作；任务运行记录可查询；失败可重试且不产生重复副作用 | 中 | 需提供任务状态/日志界面 |
    | 系统/平台管理 | 管理员与权限管理 | 支持角色/菜单权限配置、多级管理员账号、权限即时生效与角色回收 | 权限变更后被限制的操作返回403；角色管理功能穩定无权限泄露 | 高 | 支持基于角色与基于资源的细粒度权限 |
    | 系统/平台管理 | 接口限流与防护 | 全局/接口级限流、IP 黑白名单、请求速率限制、简单防刷/反爬策略 | 达到限流阈值返回规范错误码；限流规则生效且可配置；异常流量告警触发 | 高 | 可与网关或中间件协作实现 |
    | 系统/平台管理 | 健康检查与监控 | 提供服务健康检查接口、Prometheus 指标、错误与性能告警 | 健康接口返回服务状态；指标覆盖CPU/内存/请求QPS/错误率；关键告警触达渠道 | High | 集成 Prometheus/Grafana 或类似监控系统 |
    | 系统/平台管理 | 文件与静态资源管理 | 管理静态目录、图片存储策略、CDN 配置、备份与清理策略 | 上传/访问静态资源正常；图片处理后可访问；定期清理策略有效 | 中 | 使用 `pic_data/` 路径约定，支持外部存储扩展 |
    | 系统/平台管理 | 运维与部署支持 | 部署脚本、迁移脚本、环境配置模板、回滚策略与灰度发布支持 | 按文档能快速部署/回滚；迁移脚本无数据丢失；灰度发布能按配置路由一部分流量 | 中 | 提供 `pyproject.toml` / 部署说明 |
    | 系统/平台管理 | 备份与恢复 | 数据库和关键文件定期备份、备份验证、恢复演练 | 备份任务完成率 100%；恢复演练成功并产出报告；恢复时间满足合同约定 | 高 | 备份保留期、恢复点 (RPO/RTO) 在合同中明确 |
    | 系统/平台管理 | 运维权限与变更审批 | 运维操作（如手工调账/数据修复/脚本执行）需审批并记录 | 运维变更有审批流程并记录；审批后操作可回溯且有回滚方案 | High | 高风险操作双人/多级审批 |
    | 系统/平台管理 | 多环境支持 | 支持独立的开发/测试/预发布/生产环境配置与数据隔离 | 各环境间配置与数据隔离；部署脚本支持多环境参数 | 中 | 环境配置示例提供在交付物中 |
    | 系统/平台管理 | 系统通知与消息 | 提供邮件/短信/站内信模板管理与发送接口，支持任务异步发送与失败重试 | 模板可配置；发送记录可查询；发送失败自动重试并告警 | Medium | 需对接短信/邮件服务商 |
    | 系统/平台管理 | 运维自助工具 | 提供常用运维工具（清理缓存、重跑任务、导出日志、手动触发作业） | 工具权限受限；执行后产生可审计记录；工具操作正确无副作用 | Low | 仅限管理员使用 |

  - **验收占位**: 每项功能需补充“接口示例 / 管理页截图或设计说明 / 验收步骤（功能点、异常用例、权限用例）/ SLA 与告警阈值 / 备份与恢复演练计划”。

- **模块**: 接口与集成
  - **子功能占位**: 第三方登录（微信）、短信 API 对接、支付网关（微信）、邮件/通知
  - **验收占位**: 第三方交互成功率、错误处理与重试策略

说明：每个模块在最终合同清单中应展开为表格形式，列出“功能模块 / 子功能 / 功能描述 / 验收标准 / 优先级 / 备注”。

三、非功能要求（关键指标模板）

- **性能**: 支持并发用户： [占位，例如 1000 并发]；API 响应：平均 ≤ [500]ms，95% 响应 ≤ [1s]；页面首屏加载 ≤ [2]s
- **可用性**: SLA 可用率：99.5%（月）
- **扩展性**: 支持水平扩容，数据库与静态资源分离部署
- **安全**: 敏感数据加密：[AES/RSA]；密码加密：bcrypt；登录失败锁定策略：连续 N 次失败锁定 M 分钟；操作审计：管理员操作留痕
- **兼容性**: 浏览器：Chrome/Edge/Safari 最新两代；移动端：iOS 、Android
- **可维护性**: 提供接口文档（OpenAPI/Swagger）、部署手册、源码注释覆盖率 ≥ 80%
- **备份与恢复**: 数据库每日备份，备份保留期：30 天，恢复时长目标 ≤ 4 小时

四、验收与变更规则（模板）

- **验收标准**：按清单“验收标准”项逐条测试，单项通过后标注为“已通过”；整体通过率 100% 为合格交付。
- **验收流程**：
  1. 乙方完成开发并提交测试环境；
  2. 甲方在约定时间内（例如 10 个工作日）完成功能验证并提交问题清单；
  3. 乙方在约定修复周期内修复并提交复测；
  4. 双方确认全部条目通过后签署验收单。
- **变更流程**：任何功能增删改均需双方签署《需求变更确认单》，变更同时调整工期与费用。
- **缺陷分级与响应时限**：
  - 紧急（P0）：系统不可用/关键业务中断，响应 ≤ 2 小时，修复或临时解决方案 ≤ 24 小时；
  - 高（P1）：主要功能受影响，响应 ≤ 8 小时，修复或规避措施 ≤ 3 个工作日；
  - 中（P2）：次要功能/界面问题，响应 ≤ 2 个工作日，修复 ≤ 10 个工作日；
  - 低（P3）：建议性改进，双方另行评估排期。

五、交付物与交付标准

- **交付物清单**：源代码（含注释）、部署脚本、依赖清单（pyproject.toml 或 requirements.txt）、数据库初始化脚本、接口文档（OpenAPI）、部署手册、用户手册、测试报告
- **交付标准**：代码能在目标环境按文档部署并启动，接口文档与实际接口一致，关键用例通过测试

六、验收交付时间与里程碑（示例）

- **里程碑1**：需求确认与技术评估 — 日期
- **里程碑2**：开发完成（测试环境） — 日期
- **里程碑3**：甲方测试与问题修复 — 日期
- **里程碑4**：验收与生产部署 — 日期

七、知识产权与源码交付（简要）

- **代码归属**：按主合同约定。若合同约定源码交付，则乙方应提供完整源码与构建说明。
- **第三方组件**：列明所有第三方依赖及许可证，若有商业授权需由甲方另行购买。

八、签署确认

- 甲方（盖章）：__________  代表签字：__________  日期：__________
- 乙方（盖章）：__________  代表签字：__________  日期：__________

